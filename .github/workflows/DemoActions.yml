name: CI Windows - Hardcoded Paths

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-analyze-windows:
  #Test utilizzo Windows per path
    runs-on: windows-latest
    
    steps:
      - name: Checkout del codice
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Esegui test con Maven
        working-directory: HSLColor_Tests
        run: mvn test

      - name: Analisi Test Smells (Paths Hardcodati)
        working-directory: HSLColor_Tests
        continue-on-error: true
        run: |
          Write-Host "=== 1. VERIFICA JAR ==="
          $JarPath = "tools\TestSmellDetector.jar"

          if (-Not (Test-Path $JarPath)) {
            Write-Error "Errore: JAR non trovato in $JarPath. Assicurati di averlo caricato nel repo!"
            exit 1
          }

          Write-Host "=== 2. CREAZIONE INPUT.CSV (Hardcoded) ==="
          
          # Inseriamo esattamente la stringa che hai richiesto
          # Nota: PowerShell potrebbe avere problemi con le virgole se non virgolettiamo la stringa intera
          $CsvLine = "HSLProject,D:\a\GithubActionsDemo\GithubActionsDemo\HSLColor_Tests\src\test\java\org\example\TestHSLColor.java,D:\a\GithubActionsDemo\GithubActionsDemo\HSLColor_Tests\src\main\java\org\example\HSLColor.java"
          
          Write-Host "Scrivendo nel CSV: $CsvLine"
          
          # Scriviamo il file forzando la codifica ASCII (Java a volte odia l'UTF-16 di default di Windows)
          $CsvLine | Out-File -FilePath input.csv -Encoding ascii
          
          Write-Host "Contenuto file creato:"
          Get-Content input.csv

          Write-Host "=== 3. ESECUZIONE TOOL ==="
          # Eseguiamo il jar passando il file csv
          java -jar $JarPath input.csv
          
          Write-Host "=== 4. RECUPERO RISULTATI ==="
          # Cerchiamo il file di output (escludendo input.csv e i file di jacoco)
          $ResultFile = Get-ChildItem *.csv | Where-Object { $_.Name -ne "input.csv" -and $_.Name -notlike "*jacoco*" } | Select-Object -First 1
          
          if ($ResultFile) {
             Write-Host "Report generato: $($ResultFile.Name)"
             Move-Item -Path $ResultFile.FullName -Destination "smells_report.csv" -Force
             
             Write-Host "Anteprima contenuto report:"
             Get-Content smells_report.csv
          } else {
             Write-Warning "Nessun report generato."
             Write-Host "File presenti nella directory:"
             Get-ChildItem
             exit 1
          }

      - name: Commit automatico dei risultati
        if: always()
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Auto-update: Test Smells Report (Windows)"
          file_pattern: |
            HSLColor_Tests/smells_report.csv
