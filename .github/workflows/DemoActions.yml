name: Test, Coverage & Readme Update

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Scarica il codice
    - name: Checkout del codice
      uses: actions/checkout@v4

    # 2. Installa Java 11
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # 3. Esegue Test e Coverage
    - name: Esegui Test con Maven
      working-directory: ./HSLColor_Tests
      run: mvn test

    # 4. Genera i Badge di Copertura
    - name: Generate JaCoCo Badge
      id: jacoco
      uses: cicirello/jacoco-badge-generator@v2
      with:
        generate-branches-badge: true
        jacoco-csv-file: HSLColor_Tests/target/site/jacoco/jacoco.csv
        badges-directory: HSLColor_Tests/badges

    # 5. Analisi Test Smells (tsDetect - versione corretta)
    - name: Analisi Test Smells
      working-directory: ./HSLColor_Tests
      continue-on-error: true
      run: |
        # 1. Scarica il tool
        wget https://github.com/TestSmells/TestSmellDetector/releases/download/v2.2/TestSmellDetector.jar

        # 2. Definisce le directory
        TEST_DIR="$(pwd)/src/test/java"
        PROD_DIR="$(pwd)/src/main/java"

        echo "Directory Test: $TEST_DIR"
        echo "Directory Produzione: $PROD_DIR"

        # Controllo di sicurezza
        if [ ! -d "$TEST_DIR" ] || [ ! -d "$PROD_DIR" ]; then
          echo "ERRORE: Directory test o produzione non trovata"
          ls -R
          exit 1
        fi

        # 3. Crea il CSV nel formato corretto
        echo "ProjectName,TestDirPath,ProductionDirPath" > input.csv
        echo "HSLProject,$TEST_DIR,$PROD_DIR" >> input.csv

        echo "--- CONTENUTO INPUT.CSV ---"
        cat input.csv

        # 4. Esegue l'analisi
        java -jar TestSmellDetector.jar -f input.csv -o smells_report.csv

        # 5. Mostra risultato
        if [ -f smells_report.csv ]; then
          echo "--- RISULTATO ANALISI ---"
          cat smells_report.csv
        else
          echo "Attenzione: Il report non Ã¨ stato generato."
          exit 1
        fi

    # 6. Scrive i risultati nel README.md
    - name: Aggiorna README con numero Smells
      working-directory: ./
      run: |
        # Conta quante volte compare la parola "true" o "True" nel report.
        SMELL_COUNT=$(grep -o -i "true" HSLColor_Tests/smells_report.csv | wc -l)
        
        echo "Totale Smells trovati: $SMELL_COUNT"
        
        # Aggiorna il README.md (Ho ripristinato i tag mancanti nel tuo copia-incolla)
        sed -i '//,//c\\nAllo stato attuale sono stati rilevati **'"$SMELL_COUNT"'** Test Smells.\n' README.md

    # 7. Salva tutto
    - name: Commit delle modifiche
      if: always()
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update: README con Coverage e Smells count"
        file_pattern: "HSLColor_Tests/badges/*.svg README.md"
