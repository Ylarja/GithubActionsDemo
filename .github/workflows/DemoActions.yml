name: Test, Coverage & Readme Update

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Scarica il codice
    - name: Checkout del codice
      uses: actions/checkout@v4

    # 2. Installa Java 11
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # 3. Esegue Test e Coverage
    - name: Esegui Test con Maven
      working-directory: ./HSLColor_Tests
      run: mvn test

    # 4. Genera i Badge di Copertura
    - name: Generate JaCoCo Badge
      id: jacoco
      uses: cicirello/jacoco-badge-generator@v2
      with:
        generate-branches-badge: true
        jacoco-csv-file: HSLColor_Tests/target/site/jacoco/jacoco.csv
        badges-directory: HSLColor_Tests/badges

   # 5. Analisi Test Smells (Versione Intelligente)
    - name: Analisi Test Smells
      working-directory: ./HSLColor_Tests
      continue-on-error: true
      run: |
        # 1. Scarica il tool
        wget https://github.com/TestSmells/TestSmellDetector/releases/download/v2.2/TestSmellDetector.jar
        
        # 2. TROVA I FILE AUTOMATICAMENTE
        # Cerchiamo il file che inizia per "Test" e finisce per ".java"
        TEST_FILE=$(find $(pwd) -name "Test*.java" | head -n 1)
        # Cerchiamo il file di produzione (HSLColor.java)
        PROD_FILE=$(find $(pwd) -name "HSLColor.java" | head -n 1)
        
        echo "File di Test trovato: $TEST_FILE"
        echo "File di Produzione trovato: $PROD_FILE"
        
        # Se non trova i file, ferma tutto e mostraci l'errore
        if [ -z "$TEST_FILE" ] || [ -z "$PROD_FILE" ]; then
          echo "ERRORE: Non riesco a trovare i file Java. Controlla la struttura delle cartelle."
          ls -R
          exit 1
        fi

        # 3. Crea il CSV usando i percorsi assoluti appena trovati
        echo "HSLProject,$TEST_FILE,$PROD_FILE" > input.csv
        
        # Mostriamolo per debug
        echo "--- CONTENUTO INPUT.CSV ---"
        cat input.csv
        
        # 4. Esegue l'analisi
        java -jar TestSmellDetector.jar -f input.csv -o smells_report.csv
        
        # 5. Mostra il risultato
        echo "--- RISULTATO ANALISI ---"
        if [ -f smells_report.csv ]; then
            cat smells_report.csv
        else
            echo "Attenzione: Il report non Ã¨ stato generato."
            exit 1
        fi

    # 6. Scrive i risultati nel README.md
    - name: Aggiorna README con numero Smells
      working-directory: ./
      run: |
        # Conta quante volte compare la parola "true" o "True" nel report.
        # Ogni "true" corrisponde a uno smell rilevato.
        SMELL_COUNT=$(grep -o -i "true" HSLColor_Tests/smells_report.csv | wc -l)
        
        echo "Totale Smells trovati: $SMELL_COUNT"
        
        # Aggiorna il README.md
        sed -i '//,//c\\nAllo stato attuale sono stati rilevati **'"$SMELL_COUNT"'** Test Smells.\n' README.md

    # 7. Salva tutto
    - name: Commit delle modifiche
      if: always()
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update: README con Coverage e Smells count"
        file_pattern: "HSLColor_Tests/badges/*.svg README.md"
