name: Esecuzione Test e Coverage

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write  # Permesso necessario per salvare il badge nel repository

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Scarica il codice
    - name: Checkout del codice
      uses: actions/checkout@v4

    # 2. Installa Java 11
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # 3. Esegue i test (JaCoCo si attiver√† automaticamente grazie alla modifica nel pom.xml)
    - name: Esegui Test con Maven
      working-directory: ./HSLColor_Tests
      run: mvn test

    # 4. Genera il Badge di Copertura
    # Usa un'azione pronta che legge il file CSV generato da JaCoCo
    - name: Generate JaCoCo Badge
      id: jacoco
      uses: cicirello/jacoco-badge-generator@v2
      with:
        generate-branches-badge: true
        # Qui indichiamo dove JaCoCo ha salvato il report (nella tua sottocartella)
        jacoco-csv-file: HSLColor_Tests/target/site/jacoco/jacoco.csv
        # Dove salvare le immagini dei badge? Nella cartella 'badges' dentro la sottocartella
        badges-directory: HSLColor_Tests/badges

    # 5. Mostra il risultato nel log (Utile per controllo rapido)
    - name: Log coverage percentage
      run: |
        echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
        echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"

    # 6. Salva (Committa) il badge nel repository
    # Se i test passano, questo passaggio carica le immagini .svg create su GitHub
    - name: Commit Badge
      if: github.ref == 'refs/heads/main' # Esegui solo sul branch main
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update coverage badges"
        file_pattern: "HSLColor_Tests/badges/*.svg"
