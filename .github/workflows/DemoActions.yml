name: Test, Coverage & Readme Update

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # 1. Scarica il codice
    - name: Checkout del codice
      uses: actions/checkout@v4

    # 2. Installa Java 11
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven

    # 3. Esegue Test e Coverage
    - name: Esegui Test con Maven
      working-directory: ./HSLColor_Tests
      run: mvn test

    # 4. Genera i Badge di Copertura
    - name: Generate JaCoCo Badge
      id: jacoco
      uses: cicirello/jacoco-badge-generator@v2
      with:
        generate-branches-badge: true
        jacoco-csv-file: HSLColor_Tests/target/site/jacoco/jacoco.csv
        badges-directory: HSLColor_Tests/badges

    # 5. Analisi Test Smells (Versione TestSmellDetector)
    - name: Analisi Test Smells
      working-directory: ./HSLColor_Tests
      continue-on-error: true
      run: |
        # 1. Scarica il tool corretto (TestSmellDetector)
        wget https://github.com/TestSmells/TestSmellDetector/releases/download/v2.2/TestSmellDetector.jar
        
        # 2. CREA IL FILE DI INPUT CSV (Fondamentale!)
        # Formato richiesto: NomeProgetto, PathTest, PathProduzione
        # Qui mappiamo manualmente i tuoi file. Se ne aggiungi altri, dovrai aggiornare questa riga o fare uno script piÃ¹ complesso.
        echo "HSLProject,src/test/java/org/example/TestHSLColor.java,src/main/java/org/example/HSLColor.java" > input.csv
        
        # 3. Esegue l'analisi usando il file input.csv appena creato
        # Il flag -N permette di non usare l'header nel CSV di input
        java -jar TestSmellDetector.jar -f input.csv -o smells_report.csv
        
        # Mostra il report grezzo nel log (per debug)
        echo "--- CSV GENERATO ---"
        cat smells_report.csv

    # 6. Scrive i risultati nel README.md
    - name: Aggiorna README con numero Smells
      working-directory: ./
      run: |
        # Conta quante volte compare la parola "true" o "True" nel report.
        # Ogni "true" corrisponde a uno smell rilevato.
        SMELL_COUNT=$(grep -o -i "true" HSLColor_Tests/smells_report.csv | wc -l)
        
        echo "Totale Smells trovati: $SMELL_COUNT"
        
        # Aggiorna il README.md
        sed -i '//,//c\\nAllo stato attuale sono stati rilevati **'"$SMELL_COUNT"'** Test Smells.\n' README.md

    # 7. Salva tutto
    - name: Commit delle modifiche
      if: always()
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update: README con Coverage e Smells count"
        file_pattern: "HSLColor_Tests/badges/*.svg README.md"
